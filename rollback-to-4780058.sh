#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Ç–∫–∞—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–æ –∫–æ–º–º–∏—Ç–∞ 4780058
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./rollback-to-4780058.sh

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üîÑ –û—Ç–∫–∞—Ç –¥–æ –∫–æ–º–º–∏—Ç–∞ 4780058..."
echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∫–æ–º–º–∏—Ç–∞ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!"
echo ""

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /opt/bot-marzban-vpn || { echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /opt/bot-marzban-vpn –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"; exit 1; }

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if [ ! -d .git ]; then
    echo "‚ùå –≠—Ç–æ –Ω–µ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π!"
    exit 1
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞..."
pm2 stop bot-marzban-vpn || echo "‚ö†Ô∏è  –ë–æ—Ç —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω"

# –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø –ë–î –ø–µ—Ä–µ–¥ –æ—Ç–∫–∞—Ç–æ–º
echo "üíæ –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø –ë–î..."
BACKUP_DIR="/opt/bot-marzban-vpn/back"
mkdir -p "$BACKUP_DIR"
if [ -f "prisma/dev.db" ]; then
    BACKUP_FILE="$BACKUP_DIR/dev.db.backup-rollback-$(date +%Y-%m-%dT%H-%M-%S).db"
    cp prisma/dev.db "$BACKUP_FILE"
    echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $BACKUP_FILE"
elif [ -f "dev.db" ]; then
    BACKUP_FILE="$BACKUP_DIR/dev.db.backup-rollback-$(date +%Y-%m-%dT%H-%M-%S).db"
    cp dev.db "$BACKUP_FILE"
    echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $BACKUP_FILE"
else
    echo "‚ö†Ô∏è  –ë–î –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –±—ç–∫–∞–ø"
fi

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–Ω–∞ —Å–ª—É—á–∞–π –æ—Ç–∫–∞—Ç–∞)
echo "üìù –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç..."
CURRENT_COMMIT=$(git rev-parse HEAD)
echo "–¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç: $CURRENT_COMMIT"

# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo "üì• –ü–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Git..."
git fetch origin

# –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –¥–æ –Ω—É–∂–Ω–æ–≥–æ –∫–æ–º–º–∏—Ç–∞
echo "üîÑ –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –¥–æ –∫–æ–º–º–∏—Ç–∞ 4780058c973e5bb6cad2f41d2544f0b7f528fe6a..."
git reset --hard 4780058c973e5bb6cad2f41d2544f0b7f528fe6a

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–∫–∞—Ç –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ
CHECK_COMMIT=$(git rev-parse HEAD)
EXPECTED_COMMIT="4780058c973e5bb6cad2f41d2544f0b7f528fe6a"

if [ "$CHECK_COMMIT" = "$EXPECTED_COMMIT" ]; then
    echo "‚úÖ –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
    echo "–¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç: $CHECK_COMMIT"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫–∞—Ç–∞! –¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç: $CHECK_COMMIT"
    echo "–û–∂–∏–¥–∞–ª—Å—è: $EXPECTED_COMMIT"
    exit 1
fi

# –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
echo "üì¶ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
npm install

# –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
echo "üóÑÔ∏è  –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î..."
npx prisma generate || echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Prisma Client"
npx prisma migrate deploy || echo "‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π"

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
pm2 restart bot-marzban-vpn || pm2 start index.js --name bot-marzban-vpn

echo ""
echo "‚úÖ –û—Ç–∫–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üìä –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞:"
pm2 status bot-marzban-vpn

echo ""
echo "üìù –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
echo "   pm2 logs bot-marzban-vpn --lines 50"
