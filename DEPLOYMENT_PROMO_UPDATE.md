# Инструкция по обновлению промокодов на сервере

## ⚠️ ВАЖНО: Создайте резервную копию БД перед обновлением!

### 1. Создание резервной копии базы данных

```bash
# Остановите бота
pm2 stop bot-marzban-vpn

# Создайте резервную копию БД
cp /path/to/your/database.db /path/to/backup/database_backup_$(date +%Y%m%d_%H%M%S).db

# Или если используете SQLite файл:
cp dev.db dev_backup_$(date +%Y%m%d_%H%M%S).db
```

### 2. Обновление кода

```bash
# Перейдите в директорию проекта
cd /path/to/bot-marzban-vpn

# Получите последние изменения
git pull origin main

# Установите обновленные зависимости
npm install
```

### 3. Применение миграций базы данных

```bash
# Примените миграции (это безопасно - не удалит существующие данные)
npx prisma migrate deploy

# Или если используете SQLite напрямую:
DATABASE_URL="file:./dev.db" npx prisma migrate deploy
```

### 4. Перезапуск бота

```bash
# Запустите бота
pm2 restart bot-marzban-vpn

# Проверьте статус
pm2 status
pm2 logs bot-marzban-vpn
```

### 5. Проверка работоспособности

1. Проверьте, что бот отвечает на команды
2. Попробуйте активировать тестовый промокод
3. Убедитесь, что создается подписка на 10 дней
4. Проверьте, что генерируется ссылка на VPN

### 6. Откат (если что-то пошло не так)

```bash
# Остановите бота
pm2 stop bot-marzban-vpn

# Восстановите БД из резервной копии
cp /path/to/backup/database_backup_YYYYMMDD_HHMMSS.db /path/to/your/database.db

# Откатите код к предыдущей версии
git reset --hard HEAD~1

# Перезапустите бота
pm2 start bot-marzban-vpn
```

## Что изменилось в новой версии:

- ✅ Промокоды теперь дают VPN на 10 дней вместо 100 рублей
- ✅ Добавлен новый тип подписки PROMO_10D
- ✅ Интеграция с Marzban API для создания VPN пользователей
- ✅ Пользователи получают ссылку на подписку сразу после активации

## Переменные окружения

Убедитесь, что на сервере настроены:
- `MARZBAN_API_URL` - URL вашего Marzban API
- `MARZBAN_TOKEN` - токен для доступа к API (если требуется)

## Примечания

- Существующие пользователи и их балансы не пострадают
- Старые промокоды продолжат работать, но будут давать VPN вместо денег
- Новые промокоды будут создаваться с обновленной логикой
