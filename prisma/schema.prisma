datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum SubscriptionType {
  FREE
  M1
  M3
  M6
  M12
  PROMO_10D
}

model User {
  id          Int           @id @default(autoincrement())
  telegramId  String
  chatId      String
  accountName String?
  balance     Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // üëá –Ω–æ–≤—ã–µ –ø–æ–ª—è/—Å–≤—è–∑–∏
  promoCode   String?       @unique
  promoActivationsAsOwner   PromoActivation[] @relation("OwnerActivations")
  promoActivationAsUser     PromoActivation?  @relation("UserActivation")

  subscriptions Subscription[]
  topUps         TopUp[]

  @@unique([telegramId, chatId], name: "telegramId_chatId")
  @@index([telegramId])
  @@index([chatId])
}

model PromoActivation {
  id           Int      @id @default(autoincrement())
  codeOwnerId  Int
  activatorId  Int      @unique      // üîí –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–∞—Ç–æ—Ä ‚Äî –æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ª—é–±–æ–≥–æ –ø—Ä–æ–º–æ
  amount       Int      @default(100)
  createdAt    DateTime @default(now())

  // —Å–≤—è–∑–∏
  codeOwner    User     @relation("OwnerActivations", fields: [codeOwnerId], references: [id])
  activator    User     @relation("UserActivation",   fields: [activatorId], references: [id])

  @@index([codeOwnerId, createdAt])
}


model Subscription {
  id              Int              @id @default(autoincrement())
  type            SubscriptionType
  startDate       DateTime         @default(now())
  endDate         DateTime?
  userId          Int
  user            User             @relation(fields: [userId], references: [id])
  subscriptionUrl String?          // üî• –æ—Å–Ω–æ–≤–Ω–∞—è —Å—Å—ã–ª–∫–∞ (vpn.grangy.ru)
  subscriptionUrl2 String?         // üî• –≤—Ç–æ—Ä–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è rus2 (rus2.grangy.ru:8888)
  notified3Days            Boolean   @default(false)  // —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 3 –¥–Ω—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
  notified1Day             Boolean   @default(false)  // —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 1 –¥–µ–Ω—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
  lastExpiredReminderAt    DateTime?   

  @@index([userId])
  @@index([type, startDate])
}


model TopUp {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id])
  amount     Int
  status     String   @default("PENDING") // PENDING | SUCCESS | FAILED | TIMEOUT
  orderId    String   @unique              // –≤–Ω–µ—à–Ω–∏–π/–Ω–∞—à –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
  billId     String?                       // id —Å—á–µ—Ç–∞ –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ
  credited   Boolean  @default(false)      // ‚úÖ –∑–∞—á–∏—Å–ª–µ–Ω–æ –Ω–∞ –±–∞–ª–∞–Ω—Å?
  creditedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId, createdAt])
}

// –ê–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã –Ω–∞ –±–∞–ª–∞–Ω—Å
model AdminPromo {
  id         Int      @id @default(autoincrement())
  code       String   @unique              // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞
  amount     Int                           // –Ω–æ–º–∏–Ω–∞–ª –≤ —Ä—É–±–ª—è—Ö
  usedById   Int?                          // –∫—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª (null = –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω)
  usedAt     DateTime?                     // –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω
  createdAt  DateTime @default(now())
  createdBy  String?                       // –∫—Ç–æ —Å–æ–∑–¥–∞–ª (telegram id –∞–¥–º–∏–Ω–∞)
  
  @@index([code])
}


