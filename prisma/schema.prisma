datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum SubscriptionType {
  FREE
  M1
  M3
  M6
  M12
}

model User {
  id          Int           @id @default(autoincrement())
  telegramId  String
  chatId      String
  accountName String?
  balance     Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // üëá –Ω–æ–≤—ã–µ –ø–æ–ª—è/—Å–≤—è–∑–∏
  promoCode   String?       @unique
  promoActivationsAsOwner   PromoActivation[] @relation("OwnerActivations")
  promoActivationAsUser     PromoActivation?  @relation("UserActivation")

  subscriptions Subscription[]
  topUps         TopUp[]

  @@unique([telegramId, chatId], name: "telegramId_chatId")
  @@index([telegramId])
  @@index([chatId])
}

model PromoActivation {
  id           Int      @id @default(autoincrement())
  codeOwnerId  Int
  activatorId  Int      @unique      // üîí –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–∞—Ç–æ—Ä ‚Äî –æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ª—é–±–æ–≥–æ –ø—Ä–æ–º–æ
  amount       Int      @default(100)
  createdAt    DateTime @default(now())

  // —Å–≤—è–∑–∏
  codeOwner    User     @relation("OwnerActivations", fields: [codeOwnerId], references: [id])
  activator    User     @relation("UserActivation",   fields: [activatorId], references: [id])

  @@index([codeOwnerId, createdAt])
}


model Subscription {
  id              Int              @id @default(autoincrement())
  type            SubscriptionType
  startDate       DateTime         @default(now())
  endDate         DateTime?
  userId          Int
  user            User             @relation(fields: [userId], references: [id])
  subscriptionUrl String?          // üî• –Ω–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞

  @@index([userId])
  @@index([type, startDate])
}


model TopUp {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id])
  amount     Int
  status     String   @default("PENDING") // PENDING | SUCCESS | FAILED | TIMEOUT
  orderId    String   @unique              // –≤–Ω–µ—à–Ω–∏–π/–Ω–∞—à –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
  billId     String?                       // id —Å—á–µ—Ç–∞ –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ
  credited   Boolean  @default(false)      // ‚úÖ –∑–∞—á–∏—Å–ª–µ–Ω–æ –Ω–∞ –±–∞–ª–∞–Ω—Å?
  creditedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId, createdAt])
}


