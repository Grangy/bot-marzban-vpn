datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum SubscriptionType {
  FREE
  M1
  M3
  M6
  M12
  PROMO_10D
}

model User {
  id          Int           @id @default(autoincrement())
  telegramId  String
  chatId      String
  accountName String?
  balance     Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // üëá –Ω–æ–≤—ã–µ –ø–æ–ª—è/—Å–≤—è–∑–∏
  promoCode   String?       @unique
  promoActivationsAsOwner   PromoActivation[] @relation("OwnerActivations")
  promoActivationAsUser     PromoActivation?  @relation("UserActivation")
  adminPromoActivations AdminPromoActivation[] // –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∞–¥–º–∏–Ω—Å–∫–∏—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
  referralBonusesAsOwner ReferralBonus[] @relation("ReferralBonusOwner") // –±–æ–Ω—É—Å—ã –æ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
  referralBonusesAsActivator ReferralBonus[] @relation("ReferralBonusActivator") // –±–æ–Ω—É—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–Ω–µ—Å –≤–ª–∞–¥–µ–ª—å—Ü—É

  subscriptions Subscription[]
  topUps         TopUp[]

  @@unique([telegramId, chatId], name: "telegramId_chatId")
  @@index([telegramId])
  @@index([chatId])
}

model PromoActivation {
  id           Int      @id @default(autoincrement())
  codeOwnerId  Int
  activatorId  Int      @unique      // üîí –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–∞—Ç–æ—Ä ‚Äî –æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ª—é–±–æ–≥–æ –ø—Ä–æ–º–æ
  createdAt    DateTime @default(now())

  // —Å–≤—è–∑–∏
  codeOwner    User     @relation("OwnerActivations", fields: [codeOwnerId], references: [id])
  activator    User     @relation("UserActivation",   fields: [activatorId], references: [id])

  @@index([codeOwnerId, createdAt])
}


model Subscription {
  id              Int              @id @default(autoincrement())
  type            SubscriptionType
  startDate       DateTime         @default(now())
  endDate         DateTime?
  userId          Int
  user            User             @relation(fields: [userId], references: [id])
  subscriptionUrl String?          // üî• –æ—Å–Ω–æ–≤–Ω–∞—è —Å—Å—ã–ª–∫–∞ (vpn.grangy.ru)
  subscriptionUrl2 String?         // üî• –≤—Ç–æ—Ä–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è rus2 (rus2.grangy.ru:8888)
  notified3Days            Boolean   @default(false)  // —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 3 –¥–Ω—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
  notified1Day             Boolean   @default(false)  // —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 1 –¥–µ–Ω—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
  lastExpiredReminderAt    DateTime?   

  @@index([userId])
  @@index([type, startDate])
}


model TopUp {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id])
  amount     Int
  status     String   @default("PENDING") // PENDING | SUCCESS | FAILED | TIMEOUT
  orderId    String   @unique              // –≤–Ω–µ—à–Ω–∏–π/–Ω–∞—à –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
  billId     String?                       // id —Å—á–µ—Ç–∞ –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ
  credited   Boolean  @default(false)      // ‚úÖ –∑–∞—á–∏—Å–ª–µ–Ω–æ –Ω–∞ –±–∞–ª–∞–Ω—Å?
  creditedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  referralBonuses ReferralBonus[] // —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –±–æ–Ω—É—Å—ã –æ—Ç —ç—Ç–æ–≥–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è

  @@index([userId, createdAt])
}

// –ê–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã (–Ω–∞ –±–∞–ª–∞–Ω—Å –∏–ª–∏ –Ω–∞ –¥–Ω–∏)
model AdminPromo {
  id         Int      @id @default(autoincrement())
  code       String   @unique              // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞
  type       String   @default("BALANCE")  // BALANCE - –Ω–∞ –±–∞–ª–∞–Ω—Å, DAYS - –Ω–∞ –¥–Ω–∏ –ø–æ–¥–ø–∏—Å–∫–∏
  amount     Int?                          // –Ω–æ–º–∏–Ω–∞–ª –≤ —Ä—É–±–ª—è—Ö (–¥–ª—è type=BALANCE)
  days       Int?                          // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π (–¥–ª—è type=DAYS)
  isReusable Boolean  @default(false)      // –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ (–¥–ª—è –±–ª–æ–≥–µ—Ä–æ–≤)
  customName String?                       // –∫–∞—Å—Ç–æ–º–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
  usedById   Int?                          // –∫—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª (null = –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω, –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã—Ö)
  usedAt     DateTime?                     // –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω (–¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã—Ö)
  useCount   Int      @default(0)          // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π (–¥–ª—è –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã—Ö)
  createdAt  DateTime @default(now())
  createdBy  String?                       // –∫—Ç–æ —Å–æ–∑–¥–∞–ª (telegram id –∞–¥–º–∏–Ω–∞)
  
  activations AdminPromoActivation[]      // –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–Ω–æ–≥–æ—Ä–∞–∑–æ–≤—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
  
  @@index([code])
  @@index([type, createdAt])
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–π –∞–¥–º–∏–Ω—Å–∫–∏—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ (–∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑)
model AdminPromoActivation {
  id         Int      @id @default(autoincrement())
  promoId    Int                           // ID –ø—Ä–æ–º–æ–∫–æ–¥–∞
  userId     Int                           // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª
  activatedAt DateTime @default(now())       // –∫–æ–≥–¥–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª
  
  promo      AdminPromo @relation(fields: [promoId], references: [id])
  user       User       @relation(fields: [userId], references: [id])
  
  @@unique([promoId, userId])              // –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
  @@index([promoId])
  @@index([userId])
}

// –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –±–æ–Ω—É—Å—ã (20% –æ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π –≤–ª–∞–¥–µ–ª—å—Ü—É –ø—Ä–æ–º–æ–∫–æ–¥–∞)
model ReferralBonus {
  id           Int      @id @default(autoincrement())
  codeOwnerId  Int                           // –≤–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ–º–æ–∫–æ–¥–∞ (–∫—Ç–æ –ø–æ–ª—É—á–∏—Ç –±–æ–Ω—É—Å)
  activatorId  Int                           // –∫—Ç–æ –ø–æ–ø–æ–ª–Ω–∏–ª –±–∞–ª–∞–Ω—Å (–∞–∫—Ç–∏–≤–∞—Ç–æ—Ä –ø—Ä–æ–º–æ–∫–æ–¥–∞)
  topupId      Int                           // ID –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
  amount       Int                           // —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (–≤ –∫–æ–ø–µ–π–∫–∞—Ö)
  bonusAmount  Int                           // 20% –æ—Ç —Å—É–º–º—ã –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (–≤ –∫–æ–ø–µ–π–∫–∞—Ö)
  credited     Boolean  @default(false)      // –∑–∞—á–∏—Å–ª–µ–Ω –ª–∏ –±–æ–Ω—É—Å –≤–ª–∞–¥–µ–ª—å—Ü—É
  creditedAt   DateTime?                     // –∫–æ–≥–¥–∞ –∑–∞—á–∏—Å–ª–µ–Ω
  createdAt    DateTime @default(now())      // –∫–æ–≥–¥–∞ —Å–æ–∑–¥–∞–Ω –±–æ–Ω—É—Å

  // —Å–≤—è–∑–∏
  codeOwner    User     @relation("ReferralBonusOwner", fields: [codeOwnerId], references: [id])
  activator    User     @relation("ReferralBonusActivator", fields: [activatorId], references: [id])
  topup        TopUp    @relation(fields: [topupId], references: [id])

  @@index([codeOwnerId, createdAt])         // –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–æ–Ω—É—Å–æ–≤ –≤–ª–∞–¥–µ–ª—å—Ü–∞
  @@index([activatorId])                    // –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–æ–Ω—É—Å–æ–≤ –∞–∫—Ç–∏–≤–∞—Ç–æ—Ä–∞
  @@index([topupId])                        // –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—é
}


