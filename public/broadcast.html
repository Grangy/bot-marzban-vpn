<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MaxGroot ‚Äî –ü–∞–Ω–µ–ª—å —Ä–∞—Å—Å—ã–ª–æ–∫</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: {} }
    }
  </script>
  <style>
    .toast { animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards; }
    @keyframes toastIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes toastOut { to { opacity: 0; transform: translateY(-10px); } }
    .drag-over { background: rgb(99 102 241 / 0.15); border-color: rgb(99 102 241); }
    .thumb-remove { opacity: 0; transition: opacity 0.2s; }
    .thumb-wrap:hover .thumb-remove { opacity: 1; }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-600 to-violet-700 min-h-screen p-4 md:p-6 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 transition-colors">
  <!-- Toast container -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2 max-w-sm"></div>

  <!-- Key modal -->
  <div id="keyModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm hidden">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
      <div class="bg-gradient-to-r from-indigo-500 to-purple-600 px-6 py-8 text-center text-white">
        <h2 class="text-2xl font-bold">üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
        <p class="mt-2 text-sm opacity-90">–í–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ —Ä–∞—Å—Å—ã–ª–æ–∫</p>
      </div>
      <div class="p-6">
        <label for="keyInput" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á *</label>
        <input type="password" id="keyInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á" autocomplete="off"
          class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition"
          onkeydown="if(event.key==='Enter')document.getElementById('submitKeyBtn').click()">
        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">–ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ</p>
        <div id="keyError" class="mt-2 hidden text-sm text-red-600 dark:text-red-400"></div>
      </div>
      <div class="flex gap-3 justify-end px-6 py-4 bg-gray-50 dark:bg-gray-700/50">
        <button type="button" onclick="closeKeyModal()" class="px-5 py-2.5 rounded-lg font-medium bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500 transition">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" id="submitKeyBtn" onclick="submitKey()" class="px-5 py-2.5 rounded-lg font-semibold bg-indigo-500 text-white hover:bg-indigo-600 transition shadow-lg shadow-indigo-500/30">–í–æ–π—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- Main panel -->
  <div id="mainContainer" class="max-w-4xl mx-auto hidden">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl overflow-hidden">
      <div class="bg-gradient-to-r from-indigo-500 via-purple-600 to-violet-600 px-6 py-8 text-center text-white">
        <div class="flex flex-wrap items-center justify-center gap-4">
          <h1 class="text-2xl md:text-3xl font-bold">üì¢ –ü–∞–Ω–µ–ª—å —Ä–∞—Å—Å—ã–ª–æ–∫ MaxGroot</h1>
          <div class="flex gap-2">
            <button type="button" onclick="toggleDark()" class="p-2 rounded-lg bg-white/20 hover:bg-white/30 transition" title="–¢—ë–º–Ω–∞—è —Ç–µ–º–∞">üåô</button>
            <button type="button" onclick="resetAdminSecret()" class="px-3 py-1.5 rounded-lg bg-white/20 hover:bg-white/30 text-sm transition">–°–±—Ä–æ—Å–∏—Ç—å –∫–ª—é—á</button>
          </div>
        </div>
        <p class="mt-2 text-sm opacity-90">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–æ–π —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –±–æ—Ç–∞</p>
      </div>

      <div class="p-6 md:p-8">
        <!-- Stats -->
        <div id="stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <div class="rounded-xl bg-gray-50 dark:bg-gray-700/50 p-5 text-center">
            <div id="totalUsers" class="text-2xl md:text-3xl font-bold text-indigo-600 dark:text-indigo-400">‚Äì</div>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
          </div>
          <div class="rounded-xl bg-gray-50 dark:bg-gray-700/50 p-5 text-center">
            <div id="activeUsers" class="text-2xl md:text-3xl font-bold text-emerald-600 dark:text-emerald-400">‚Äì</div>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">–ê–∫—Ç–∏–≤–Ω—ã—Ö</p>
          </div>
          <div class="col-span-2 flex items-center gap-2">
            <button type="button" onclick="copyStats()" class="px-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 text-sm font-medium transition">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
          </div>
        </div>

        <form id="broadcastForm" class="space-y-6">
          <!-- Type -->
          <div>
            <label for="broadcastType" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">–¢–∏–ø —Ä–∞—Å—Å—ã–ª–∫–∏ *</label>
            <select id="broadcastType" name="type"
              class="w-full max-w-md px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:border-indigo-500 outline-none transition appearance-none bg-[length:1.5rem] bg-[right_0.5rem_center] bg-no-repeat pr-12"
              style="background-image: url(&quot;data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3e%3c/svg%3e&quot;);">
              <option value="single">üì± –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
              <option value="active" selected>‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏</option>
              <option value="all">üåç –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
              <option value="all_except_active">üì≠ –í—Å–µ, –∫—Ä–æ–º–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö</option>
            </select>
          </div>

          <!-- Telegram ID (single) -->
          <div id="telegramIdGroup" class="hidden">
            <label for="telegramId" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Telegram ID *</label>
            <input type="text" id="telegramId" name="telegramId" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 683203214"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:border-indigo-500 outline-none transition">
          </div>

          <!-- Images: drag-n-drop -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">üñºÔ∏è –ö–∞—Ä—Ç–∏–Ω–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <div id="dropZone" class="rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-600 p-8 text-center transition bg-gray-50/50 dark:bg-gray-700/30 cursor-pointer hover:border-indigo-400 dark:hover:border-indigo-500">
              <p class="text-gray-500 dark:text-gray-400">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ <span class="text-indigo-600 dark:text-indigo-400 font-medium">–≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã</span></p>
              <p class="mt-1 text-xs text-gray-400 dark:text-gray-500">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ (JPEG, PNG, WebP)</p>
              <input type="file" id="fileInput" accept="image/jpeg,image/png,image/webp" multiple class="hidden">
            </div>
            <div id="thumbnails" class="mt-4 flex flex-wrap gap-3"></div>
          </div>

          <!-- Message -->
          <div>
            <div class="flex justify-between items-center mb-2">
              <label for="message" class="block text-sm font-semibold text-gray-700 dark:text-gray-300">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è *</label>
              <span id="charCount" class="text-xs text-gray-500 dark:text-gray-400">0</span>
            </div>
            <textarea id="message" name="message" rows="8" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç‚Ä¶ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è HTML: &lt;b&gt;, &lt;i&gt;, &lt;code&gt;, &lt;a href=&quot;‚Ä¶&quot;&gt;"
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:border-indigo-500 outline-none transition resize-y font-mono text-sm"></textarea>
            <div class="mt-2 flex flex-wrap gap-2">
              <button type="button" onclick="insertFormat('b')" class="px-2 py-1 rounded bg-gray-200 dark:bg-gray-600 text-xs font-medium hover:bg-gray-300 dark:hover:bg-gray-500">–∂–∏—Ä–Ω—ã–π</button>
              <button type="button" onclick="insertFormat('i')" class="px-2 py-1 rounded bg-gray-200 dark:bg-gray-600 text-xs font-medium hover:bg-gray-300 dark:hover:bg-gray-500">–∫—É—Ä—Å–∏–≤</button>
              <button type="button" onclick="insertFormat('code')" class="px-2 py-1 rounded bg-gray-200 dark:bg-gray-600 text-xs font-medium hover:bg-gray-300 dark:hover:bg-gray-500">–∫–æ–¥</button>
              <button type="button" onclick="insertEmoji('üöÄ')" class="px-2 py-1 rounded bg-gray-200 dark:bg-gray-600 text-xs hover:bg-gray-300 dark:hover:bg-gray-500">üöÄ</button>
              <button type="button" onclick="insertEmoji('‚úÖ')" class="px-2 py-1 rounded bg-gray-200 dark:bg-gray-600 text-xs hover:bg-gray-300 dark:hover:bg-gray-500">‚úÖ</button>
              <button type="button" onclick="insertEmoji('üíô')" class="px-2 py-1 rounded bg-gray-200 dark:bg-gray-600 text-xs hover:bg-gray-300 dark:hover:bg-gray-500">üíô</button>
            </div>
          </div>

          <!-- WebApp button -->
          <label class="flex items-center gap-3 p-4 rounded-xl bg-gray-50 dark:bg-gray-700/50 cursor-pointer">
            <input type="checkbox" id="hasWebAppButton" name="hasWebAppButton" class="w-5 h-5 rounded">
            <span class="text-gray-700 dark:text-gray-300">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É ¬´üì± –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ¬ª</span>
          </label>

          <!-- Actions -->
          <div class="flex flex-wrap gap-3 pt-2">
            <button type="button" onclick="previewMessage()" class="px-6 py-3 rounded-xl font-semibold bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-500 transition">üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
            <button type="submit" id="sendBtn" class="px-6 py-3 rounded-xl font-semibold bg-indigo-500 text-white hover:bg-indigo-600 transition shadow-lg shadow-indigo-500/30 disabled:opacity-50 disabled:cursor-not-allowed">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </form>

        <!-- Preview -->
        <div id="preview" class="mt-8 p-6 rounded-xl bg-gray-100 dark:bg-gray-700/50 border-l-4 border-indigo-500 hidden"></div>

        <!-- Loading -->
        <div id="loading" class="mt-8 hidden text-center">
          <div class="inline-block w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
          <p class="mt-3 text-gray-600 dark:text-gray-400">–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π‚Ä¶</p>
        </div>

        <!-- Results -->
        <div id="results" class="mt-8 p-6 rounded-xl hidden">
          <h3 id="resultsTitle" class="text-lg font-bold mb-4"></h3>
          <div id="resultsContent"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin;
    const STORAGE_KEY = 'maxgroot_broadcast_admin_secret';
    const DRAFT_KEY = 'maxgroot_broadcast_draft';
    let ADMIN_SECRET = null;
    let selectedFiles = [];

    function toast(msg, type = 'info') {
      const el = document.createElement('div');
      el.className = `toast px-4 py-3 rounded-xl shadow-lg ${type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-emerald-500' : 'bg-gray-800 dark:bg-gray-700'} text-white text-sm`;
      el.textContent = msg;
      document.getElementById('toastContainer').appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }

    function showKeyModal() {
      document.getElementById('keyModal').classList.remove('hidden');
      const inp = document.getElementById('keyInput');
      inp.value = '';
      inp.focus();
      const errEl = document.getElementById('keyError');
      errEl.classList.add('hidden');
      errEl.textContent = '';
    }

    function closeKeyModal() {
      document.getElementById('keyModal').classList.add('hidden');
      if (!ADMIN_SECRET) document.getElementById('mainContainer').classList.add('hidden');
    }

    function submitKey() {
      const secret = document.getElementById('keyInput').value.trim();
      const errEl = document.getElementById('keyError');
      if (!secret) {
        errEl.textContent = '‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á';
        errEl.classList.remove('hidden');
        return;
      }
      ADMIN_SECRET = secret;
      localStorage.setItem(STORAGE_KEY, secret);
      closeKeyModal();
      document.getElementById('mainContainer').classList.remove('hidden');
      loadStats();
      toast('–ö–ª—é—á —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
    }

    function resetAdminSecret() {
      if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –∫–ª—é—á? –ü–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤–≤–æ–¥.')) return;
      localStorage.removeItem(STORAGE_KEY);
      ADMIN_SECRET = null;
      document.getElementById('mainContainer').classList.add('hidden');
      showKeyModal();
      toast('–ö–ª—é—á —Å–±—Ä–æ—à–µ–Ω');
    }

    function toggleDark() {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('maxgroot_broadcast_dark', document.documentElement.classList.contains('dark'));
      toast(document.documentElement.classList.contains('dark') ? '–¢—ë–º–Ω–∞—è —Ç–µ–º–∞' : '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞');
    }

    if (localStorage.getItem('maxgroot_broadcast_dark') === 'true') document.documentElement.classList.add('dark');

    document.getElementById('keyModal').addEventListener('click', e => { if (e.target.id === 'keyModal') closeKeyModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape' && !document.getElementById('keyModal').classList.contains('hidden')) closeKeyModal(); });

    function init() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        ADMIN_SECRET = saved;
        document.getElementById('mainContainer').classList.remove('hidden');
        loadStats();
        loadDraft();
        toggleTelegramIdGroup();
      } else showKeyModal();
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();

    function toggleTelegramIdGroup() {
      const type = document.getElementById('broadcastType')?.value;
      const g = document.getElementById('telegramIdGroup');
      const tid = document.getElementById('telegramId');
      if (type === 'single') {
        g?.classList.remove('hidden');
        if (tid) tid.required = true;
      } else {
        g?.classList.add('hidden');
        if (tid) tid.required = false;
      }
    }

    function loadDraft() {
      try {
        const d = JSON.parse(localStorage.getItem(DRAFT_KEY) || '{}');
        if (d.message) document.getElementById('message').value = d.message;
        const sel = document.getElementById('broadcastType');
        if (d.type && sel && ['single','active','all','all_except_active'].includes(d.type)) sel.value = d.type;
        if (d.telegramId) document.getElementById('telegramId').value = d.telegramId;
        if (d.hasWebAppButton) document.getElementById('hasWebAppButton').checked = true;
        toggleTelegramIdGroup();
        updateCharCount();
      } catch (_) {}
    }

    function saveDraft() {
      const msg = document.getElementById('message').value;
      const type = document.getElementById('broadcastType')?.value;
      const tid = document.getElementById('telegramId').value;
      const web = document.getElementById('hasWebAppButton').checked;
      localStorage.setItem(DRAFT_KEY, JSON.stringify({ message: msg, type, telegramId: tid, hasWebAppButton: web }));
    }

    document.getElementById('message')?.addEventListener('input', () => { updateCharCount(); saveDraft(); });
    document.getElementById('message')?.addEventListener('keydown', e => {
      if (e.ctrlKey && e.key === 'Enter') { e.preventDefault(); document.getElementById('broadcastForm').requestSubmit(); }
    });
    document.getElementById('broadcastType')?.addEventListener('change', () => { toggleTelegramIdGroup(); saveDraft(); });

    function updateCharCount() {
      const n = (document.getElementById('message')?.value || '').length;
      const el = document.getElementById('charCount');
      if (el) el.textContent = n;
    }

    function insertFormat(tag) {
      const ta = document.getElementById('message');
      const s = ta.selectionStart, e = ta.selectionEnd, t = ta.value;
      const open = `<${tag}>`, close = `</${tag}>`;
      ta.value = t.slice(0, s) + open + (s !== e ? t.slice(s, e) : '‚Ä¶') + close + t.slice(e);
      ta.selectionStart = ta.selectionEnd = s + open.length + (s !== e ? e - s : 1);
      ta.focus();
      updateCharCount();
      saveDraft();
    }

    function insertEmoji(emoji) {
      const ta = document.getElementById('message');
      const s = ta.selectionStart;
      ta.value = ta.value.slice(0, s) + emoji + ta.value.slice(s);
      ta.selectionStart = ta.selectionEnd = s + emoji.length;
      ta.focus();
      updateCharCount();
      saveDraft();
    }

    function copyStats() {
      const total = document.getElementById('totalUsers')?.textContent ?? '‚Äì';
      const active = document.getElementById('activeUsers')?.textContent ?? '‚Äì';
      const text = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: ${total}\n–ê–∫—Ç–∏–≤–Ω—ã—Ö: ${active}`;
      navigator.clipboard.writeText(text).then(() => toast('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞', 'success')).catch(() => toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 'error'));
    }

    function previewMessage() {
      const msg = document.getElementById('message').value;
      const prev = document.getElementById('preview');
      if (msg) {
        prev.innerHTML = msg.replace(/\n/g, '<br>');
        prev.classList.remove('hidden');
      } else prev.classList.add('hidden');
    }

    // ‚Äî‚Äî‚Äî Drag-n-drop images ‚Äî‚Äî‚Äî
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const thumbnails = document.getElementById('thumbnails');

    function addFiles(files) {
      const allowed = ['image/jpeg', 'image/png', 'image/webp'];
      for (const f of files) {
        if (!allowed.includes(f.type) || selectedFiles.some(x => x.name === f.name && x.size === f.size)) continue;
        selectedFiles.push(f);
      }
      renderThumbnails();
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      renderThumbnails();
    }

    function renderThumbnails() {
      thumbnails.innerHTML = '';
      selectedFiles.forEach((f, i) => {
        const wrap = document.createElement('div');
        wrap.className = 'thumb-wrap relative inline-block';
        const img = document.createElement('img');
        img.src = URL.createObjectURL(f);
        img.className = 'w-20 h-20 object-cover rounded-lg border-2 border-gray-200 dark:border-gray-600';
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'thumb-remove absolute -top-1 -right-1 w-6 h-6 rounded-full bg-red-500 text-white text-sm leading-none hover:bg-red-600';
        btn.textContent = '√ó';
        btn.onclick = () => removeFile(i);
        wrap.appendChild(img);
        wrap.appendChild(btn);
        thumbnails.appendChild(wrap);
      });
    }

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      addFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', () => { addFiles(fileInput.files); fileInput.value = ''; });

    // ‚Äî‚Äî‚Äî Form submit ‚Äî‚Äî‚Äî
    document.getElementById('broadcastForm').addEventListener('submit', async e => {
      e.preventDefault();
      const type = document.getElementById('broadcastType')?.value;
      const message = document.getElementById('message').value.trim();
      const telegramId = document.getElementById('telegramId').value.trim();
      const hasWebAppButton = document.getElementById('hasWebAppButton').checked;

      if (type === 'single' && !telegramId) {
        toast('–í–≤–µ–¥–∏—Ç–µ Telegram ID', 'error');
        return;
      }
      if (!message && selectedFiles.length === 0) {
        toast('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏/–∏–ª–∏ –ø—Ä–∏–ª–æ–∂–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏', 'error');
        return;
      }

      const names = {
        single: '–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é',
        active: '–∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–¥–ø–∏—Å–∫–∞–º',
        all: '–≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º',
        all_except_active: '–≤—Å–µ–º, –∫—Ä–æ–º–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö'
      };
      if (!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É ${names[type] || type}?`)) return;

      const loading = document.getElementById('loading');
      const sendBtn = document.getElementById('sendBtn');
      const results = document.getElementById('results');
      loading.classList.remove('hidden');
      sendBtn.disabled = true;
      results.classList.add('hidden');

      const photosBase64 = await Promise.all(selectedFiles.map(f => {
        return new Promise((res, rej) => {
          const r = new FileReader();
          r.onload = () => res(r.result);
          r.onerror = rej;
          r.readAsDataURL(f);
        });
      }));

      const body = {
        type,
        message,
        telegramId: type === 'single' ? telegramId : undefined,
        parseMode: 'HTML',
        hasWebAppButton,
        photos: photosBase64
      };

      try {
        const resp = await fetch(`${API_URL}/admin/broadcast/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Admin-Secret': ADMIN_SECRET },
          body: JSON.stringify(body)
        });
        const data = await resp.json();
        loading.classList.add('hidden');
        sendBtn.disabled = false;

        if (data.ok) {
          const r = data.results;
          document.getElementById('resultsTitle').textContent = '‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
          document.getElementById('resultsContent').innerHTML = `
            <p class="mb-2"><strong>–í—Å–µ–≥–æ:</strong> ${r.total} ¬∑ <strong>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:</strong> ${r.sent} ¬∑ <strong>–û—à–∏–±–æ–∫:</strong> ${r.failed}</p>
            ${(r.errors && r.errors.length) ? `<ul class="list-disc list-inside text-sm text-gray-600 dark:text-gray-400">${r.errors.slice(0, 10).map(e => `<li>ID ${e.telegramId}: ${e.message || e.error}</li>`).join('')}</ul>` : ''}
          `;
          results.className = 'mt-8 p-6 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-200 dark:border-emerald-800';
          results.classList.remove('hidden');
          results.style.display = 'block';
          loadStats();
          toast('–†–∞—Å—Å—ã–ª–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞', 'success');
          selectedFiles = [];
          renderThumbnails();
          document.getElementById('message').value = '';
          updateCharCount();
          saveDraft();
        } else {
          document.getElementById('resultsTitle').textContent = '‚ùå –û—à–∏–±–∫–∞';
          document.getElementById('resultsContent').innerHTML = `<p>${data.message || data.error}</p>`;
          results.className = 'mt-8 p-6 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800';
          results.classList.remove('hidden');
          results.style.display = 'block';
          toast(data.message || data.error, 'error');
          if (data.error === 'UNAUTHORIZED') {
            localStorage.removeItem(STORAGE_KEY);
            ADMIN_SECRET = null;
            document.getElementById('mainContainer').classList.add('hidden');
            showKeyModal();
            document.getElementById('keyError').textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á';
            document.getElementById('keyError').classList.remove('hidden');
          }
        }
      } catch (err) {
        loading.classList.add('hidden');
        sendBtn.disabled = false;
        document.getElementById('resultsTitle').textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
        document.getElementById('resultsContent').innerHTML = `<p>${err.message}</p>`;
        results.className = 'mt-8 p-6 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800';
        results.classList.remove('hidden');
        results.style.display = 'block';
        toast(err.message, 'error');
        if (String(err.message).includes('401') || String(err.message).includes('UNAUTHORIZED')) {
          localStorage.removeItem(STORAGE_KEY);
          ADMIN_SECRET = null;
          document.getElementById('mainContainer').classList.add('hidden');
          showKeyModal();
        }
      }
    });

    async function loadStats() {
      try {
        const r = await fetch(`${API_URL}/admin/broadcast/stats`, { headers: { 'X-Admin-Secret': ADMIN_SECRET } });
        const data = await r.json();
        if (data.ok && data.stats) {
          document.getElementById('totalUsers').textContent = data.stats.totalUsers ?? 0;
          document.getElementById('activeUsers').textContent = data.stats.activeUsers ?? 0;
        } else if (!r.ok || data.error === 'UNAUTHORIZED') {
          localStorage.removeItem(STORAGE_KEY);
          ADMIN_SECRET = null;
          document.getElementById('mainContainer').classList.add('hidden');
          showKeyModal();
          const errEl = document.getElementById('keyError');
          errEl.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á';
          errEl.classList.remove('hidden');
        }
      } catch (e) {
        console.error('loadStats', e);
      }
    }
  </script>
</body>
</html>
