# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∞—É–¥–∏—Ç—É –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º —Å –±–∞–ª–∞–Ω—Å–æ–º

## –ü—Ä–æ–±–ª–µ–º–∞

–ò–∑-–∑–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∫–ª—é—á–∞ `[telegramId, chatId]` –≤ —Å—Ö–µ–º–µ –ë–î –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –æ–¥–Ω–∏–º `telegramId`, –Ω–æ —Ä–∞–∑–Ω—ã–º–∏ `chatId`. –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫:
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é –±–∞–ª–∞–Ω—Å–∞ –≤ API
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø—Ä–æ–º–æ–∫–æ–¥—É
- –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

## –†–µ—à–µ–Ω–∏–µ

### 1. –ê—É–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î:

```bash
cd /opt/bot-marzban-vpn
node audit-db.js 683203214
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –¥–∞–Ω–Ω—ã–º `telegramId`
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å –∏–∑ –ë–î –∏ —Ä–∞—Å—á–µ—Ç–Ω—ã–π –±–∞–ª–∞–Ω—Å
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –ø–æ–¥–ø–∏—Å–∫–∏, –ø—Ä–æ–º–æ–∫–æ–¥—ã
- –í—ã—è–≤–ª—è–µ—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –∏ –ø—Ä–æ–±–ª–µ–º—ã

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
üîç –ê–£–î–ò–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: 683203214
üìä –ù–ê–ô–î–ï–ù–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô: 2
‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ù–∞–π–¥–µ–Ω–æ 2 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –æ–¥–Ω–∏–º telegramId!

üë§ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ #1 (ID: 1)
  –ë–∞–ª–∞–Ω—Å –≤ –ë–î: 0 ‚ÇΩ
  –ü—Ä–æ–º–æ–∫–æ–¥: 14C68277
  ...

üë§ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ #2 (ID: 5)
  –ë–∞–ª–∞–Ω—Å –≤ –ë–î: 270 ‚ÇΩ
  –ü—Ä–æ–º–æ–∫–æ–¥: 47202601
  ...

‚ö†Ô∏è  –†–ê–°–•–û–ñ–î–ï–ù–ò–ï: -270 ‚ÇΩ
```

### 2. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

**–í–ê–ñ–ù–û:** –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (dry-run):

```bash
cd /opt/bot-marzban-vpn
node fix-user-duplicates.js 683203214 --dry-run
```

–≠—Ç–æ –ø–æ–∫–∞–∂–µ—Ç, —á—Ç–æ –±—É–¥–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–æ, **–±–µ–∑ –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ë–î**.

**–ï—Å–ª–∏ –≤—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π:**

```bash
cd /opt/bot-marzban-vpn
node fix-user-duplicates.js 683203214
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –¥–∞–Ω–Ω—ã–º `telegramId`
- –í—ã–±–∏—Ä–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π)
- –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã (–±–µ—Ä–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π)
- –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏, –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è, –ø—Ä–æ–º–æ–∫–æ–¥—ã
- –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –ø—Ä–æ–º–æ-–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
- –£–¥–∞–ª—è–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ü–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è:**
- –û—Å—Ç–∞–µ—Ç—Å—è –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- –ë–∞–ª–∞–Ω—Å = –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–∑ –≤—Å–µ—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- –ü—Ä–æ–º–æ–∫–æ–¥ = –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
- –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ API

–ü–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á–µ—Ä–µ–∑ API:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
curl https://grangy.ru/api/user/683203214/duplicates \
  -H "X-Webapp-Secret: maxgroot_webapp_secret_key_2026"

# –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –±–∞–ª–∞–Ω—Å–∞
curl https://grangy.ru/api/user/683203214/balance/debug \
  -H "X-Webapp-Secret: maxgroot_webapp_secret_key_2026"
```

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞

–ï—Å–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ –Ω–∞–ø—Ä—è–º—É—é:

```bash
cd /opt/bot-marzban-vpn
sqlite3 prisma/dev.db "UPDATE User SET promoCode = '47202601' WHERE telegramId = '683203214' AND promoCode != '47202601';"
```

**–ò–ª–∏ —á–µ—Ä–µ–∑ Prisma Studio:**
```bash
cd /opt/bot-marzban-vpn
npx prisma studio
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞

–ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ä–∞—Å—á–µ—Ç–Ω—ã–º, –º–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –µ–≥–æ:

```bash
cd /opt/bot-marzban-vpn
node audit-db.js 683203214
```

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ `calculatedBalance` –∏–∑ –≤—ã–≤–æ–¥–∞ –∏ –æ–±–Ω–æ–≤–∏—Ç–µ:

```bash
sqlite3 prisma/dev.db "UPDATE User SET balance = 270 WHERE telegramId = '683203214' AND id = <USER_ID>;"
```

**–í–ê–ñ–ù–û:** –ó–∞–º–µ–Ω–∏—Ç–µ `<USER_ID>` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∞—É–¥–∏—Ç–∞.

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É:**
```bash
ssh root@grangy.ru
```

**2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±–æ—Ç–∞:**
```bash
cd /opt/bot-marzban-vpn
```

**3. –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥:**
```bash
git pull
npm install
```

**4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∞—É–¥–∏—Ç:**
```bash
node audit-db.js 683203214
```

**5. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã, –æ–±—ä–µ–¥–∏–Ω–∏—Ç–µ –∏—Ö:**
```bash
# –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä
node fix-user-duplicates.js 683203214 --dry-run

# –ó–∞—Ç–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ
node fix-user-duplicates.js 683203214
```

**6. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:**
```bash
pm2 restart bot-marzban-vpn
```

**7. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á–µ—Ä–µ–∑ API:**
```bash
curl https://grangy.ru/api/user/683203214/balance/debug \
  -H "X-Webapp-Secret: maxgroot_webapp_secret_key_2026" | jq .
```

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- **–í—Å–µ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ `--dry-run` —Å–Ω–∞—á–∞–ª–∞** –ø–µ—Ä–µ–¥ —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
- **–°–¥–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ë–î** –ø–µ—Ä–µ–¥ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ–º –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- –ü–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ endpoints —á–µ—Ä–µ–∑ API
- –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞: `pm2 logs bot-marzban-vpn`
