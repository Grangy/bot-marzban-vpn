#!/bin/bash
# rollback-and-restore-server.sh - –û—Ç–∫–∞—Ç Git –¥–æ –∫–æ–º–º–∏—Ç–∞ 47668960 –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î –∏–∑ –±—ç–∫–∞–ø–∞

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

echo "üöÄ –û—Ç–∫–∞—Ç Git –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
echo ""

# –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
PROJECT_DIR="/opt/bot-marzban-vpn"
DB_PATH="./prisma/dev.db"
BACKUP_DIR="./back"
BACKUP_FILE="backup-2026-01-19T10-03-56-845Z.db"
COMMIT_HASH="47668960a445989e718182e2556f021be0d3a0a0"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -d "$PROJECT_DIR" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $PROJECT_DIR"
    exit 1
fi

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$PROJECT_DIR"

# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PM2 –ø—Ä–æ—Ü–µ—Å—Å
echo "‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞..."
pm2 stop bot-marzban-vpn || echo "‚ö†Ô∏è  –ë–æ—Ç –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω"
echo ""

# 2. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Ç–µ–∫—É—â–µ–π –ë–î (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Ç–µ–∫—É—â–µ–π –ë–î..."
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
CURRENT_BACKUP="backup_before_rollback_${TIMESTAMP}.db"

mkdir -p "$BACKUP_DIR"

if [ -f "$DB_PATH" ]; then
    cp "$DB_PATH" "$BACKUP_DIR/$CURRENT_BACKUP"
    DB_SIZE=$(du -h "$BACKUP_DIR/$CURRENT_BACKUP" | cut -f1)
    echo "‚úÖ –¢–µ–∫—É—â–∏–π –±—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $BACKUP_DIR/$CURRENT_BACKUP (${DB_SIZE})"
else
    echo "‚ö†Ô∏è  –¢–µ–∫—É—â–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $DB_PATH"
fi
echo ""

# 3. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Git —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º (force-pushed)
echo "üì• –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Git —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º..."
git fetch origin
git reset --hard origin/main

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–∞ –Ω—É–∂–Ω–æ–º –∫–æ–º–º–∏—Ç–µ
CURRENT_COMMIT=$(git rev-parse HEAD)
if [ "$CURRENT_COMMIT" != "$COMMIT_HASH" ]; then
    echo "‚ö†Ô∏è  –¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç: $CURRENT_COMMIT"
    echo "‚ö†Ô∏è  –û–∂–∏–¥–∞–ª—Å—è: $COMMIT_HASH"
    echo "üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω—É–∂–Ω—ã–π –∫–æ–º–º–∏—Ç..."
    git reset --hard "$COMMIT_HASH"
fi
echo "‚úÖ Git –æ—Ç–∫–∞—á–µ–Ω –¥–æ –∫–æ–º–º–∏—Ç–∞: $COMMIT_HASH"
echo ""

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞ –±—ç–∫–∞–ø–∞
BACKUP_PATH="$BACKUP_DIR/$BACKUP_FILE"
if [ ! -f "$BACKUP_PATH" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω: $BACKUP_PATH"
    echo "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –±—ç–∫–∞–ø—ã –≤ $BACKUP_DIR:"
    ls -lh "$BACKUP_DIR"/*.db 2>/dev/null || echo "   (–Ω–µ—Ç .db —Ñ–∞–π–ª–æ–≤)"
    exit 1
fi

BACKUP_SIZE=$(du -h "$BACKUP_PATH" | cut -f1)
echo "‚úÖ –ù–∞–π–¥–µ–Ω –±—ç–∫–∞–ø: $BACKUP_PATH (${BACKUP_SIZE})"
echo ""

# 5. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±—ç–∫–∞–ø–∞..."
mkdir -p "$(dirname "$DB_PATH")"

# –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â—É—é –ë–î –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ -f "$DB_PATH" ]; then
    rm -f "$DB_PATH"
    echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∞ —Ç–µ–∫—É—â–∞—è –ë–î"
fi

# –ö–æ–ø–∏—Ä—É–µ–º –±—ç–∫–∞–ø
cp "$BACKUP_PATH" "$DB_PATH"
echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑: $BACKUP_FILE"
echo ""

# 6. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install
echo ""

# 7. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma Client
echo "üî® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma Client..."
npx prisma generate
echo ""

# 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
if [ -f "$DB_PATH" ]; then
    DB_SIZE=$(du -h "$DB_PATH" | cut -f1)
    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: $DB_PATH (${DB_SIZE})"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—ã —á–µ—Ä–µ–∑ sqlite3 (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
    if command -v sqlite3 &> /dev/null; then
        TABLE_COUNT=$(sqlite3 "$DB_PATH" "SELECT COUNT(*) FROM sqlite_master WHERE type='table';" 2>/dev/null || echo "0")
        echo "üìä –ù–∞–π–¥–µ–Ω–æ —Ç–∞–±–ª–∏—Ü: $TABLE_COUNT"
    fi
else
    echo "‚ùå –û—à–∏–±–∫–∞: –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞!"
    exit 1
fi
echo ""

# 9. ‚ö†Ô∏è –í–ê–ñ–ù–û: –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º db push –∏–ª–∏ migrate deploy –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è!
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω—É–∂–Ω—É—é —Å—Ö–µ–º—É –∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±—ç–∫–∞–ø–∞.
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ db push –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö.
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ –±—ç–∫–∞–ø–∞."
echo "   –ï—Å–ª–∏ —Å—Ö–µ–º–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å Prisma schema, –≤–∞–º –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è:"
echo "   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ö–µ–º—ã –≤—Ä—É—á–Ω—É—é"
echo "   - –ò–ª–∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏: npx prisma migrate deploy (—Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é!)"
echo ""

# 10. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
echo "üîÑ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
pm2 start index.js --name "bot-marzban-vpn" || pm2 restart bot-marzban-vpn
echo ""

# 11. –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
echo "üìä –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞:"
pm2 status
echo ""

# 12. –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–æ–≤ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏):"
sleep 2  # –î–∞–µ–º –±–æ—Ç—É –≤—Ä–µ–º—è –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
pm2 logs bot-marzban-vpn --lines 15 --nostream || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏"
echo ""

echo "‚úÖ –û—Ç–∫–∞—Ç –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "üìù –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
echo "   - Git –æ—Ç–∫–∞—á–µ–Ω –¥–æ –∫–æ–º–º–∏—Ç–∞: $COMMIT_HASH"
echo "   - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑: $BACKUP_FILE"
echo "   - –¢–µ–∫—É—â–∏–π –±—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: $BACKUP_DIR/$CURRENT_BACKUP"
echo ""
echo "üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: pm2 logs bot-marzban-vpn"
echo "   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞: pm2 status"
echo "   - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞: pm2 restart bot-marzban-vpn"
echo ""
